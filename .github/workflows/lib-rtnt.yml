name: CI/CD R-Type (rtnt)

on:
    pull_request:
        branches: ["main", "dev"]
    push:
        branches: ["*rtnt*"]

jobs:
    build-and-test-on-rtnt:
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false # If one failed, don't cancel the other jobs (Kinda like a debug option)
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive # Checkout doesn't fetch submodules so it has to be done manually

            - name: Install system dependencies (Linux)
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential \
                    cmake \
                    ninja-build \
                    pkg-config  \
                    g++-15

            - name: Set GCC 15 as default compiler (Linux)
              if: matrix.os == 'ubuntu-latest'
              shell: bash
              run: |
                  echo "CC=gcc-15" >> $GITHUB_ENV
                  echo "CXX=g++-15" >> $GITHUB_ENV

            - name: Install system dependencies (Mac)
              if: matrix.os == 'macos-latest'
              run: brew install cmake ninja

            - name: Setup Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.x"

            - name: Install Conan
              run: pip install conan

            - name: Configure Conan Profile
              run: conan profile detect --force

            - name: Get Conan home
              id: conan_home
              shell: bash
              run: |
                  echo "home=$(conan config home)" >> $GITHUB_OUTPUT

            - name: Cache Conan packages
              id: cache-conan
              uses: actions/cache@v4
              with:
                  path: ${{ steps.conan_home.outputs.home }}
                  key: conan-${{ matrix.os }}-${{ hashFiles('conanfile.txt') }}
                  restore-keys: |
                      conan-${{ matrix.os }}-

            - name: Setup MSVC environment (Windows)
              if: matrix.os == 'windows-latest'
              shell: powershell
              run: |
                # Find latest VS installation and run the Dev Cmd script so cl.exe is on PATH
                $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
                if (-not $vsPath) { throw "vswhere/Visual Studio not found" }
                & "$vsPath\Common7\Tools\VsDevCmd.bat" -arch=amd64

            - name: Install all dependencies with conan (Linux)
              if: matrix.os == 'ubuntu-latest'
              shell: bash
              env:
                CC: gcc-15
                CXX: g++-15
              run: |
                conan install lib/rtnt                            \
                  --output-folder=lib/rtnt/build                  \
                  --build=missing                                 \
                  -s build_type=Release                           \
                  -s compiler=gcc                                 \
                  -s compiler.version=15                          \
                  -s compiler.cppstd=23                           \
                  -s compiler.libcxx=libstdc++11                  \
                  -c tools.system.package_manager:mode=install    \
                  -c tools.system.package_manager:sudo=True

            - name: Install all dependencies with conan (macOS)
              if: matrix.os == 'macos-latest'
              shell: bash
              env:
                CC: clang
                CXX: clang++
              run: |
                conan install lib/rtnt                            \
                  --output-folder=lib/rtnt/build                  \
                  --build=missing                                 \
                  -s build_type=Release                           \
                  -s compiler=apple-clang                         \
                  -s compiler.cppstd=23                           \
                  -s compiler.libcxx=libc++                       \
                  -c tools.system.package_manager:mode=install    \
                  -c tools.system.package_manager:sudo=True

            - name: Install all dependencies with conan (Windows / MSVC)
              if: matrix.os == 'windows-latest'
              shell: cmd
              run: |
                conan install lib/rtnt                            ^
                  --output-folder=lib/rtnt/build                  ^
                  --build=missing                                 ^
                  -s build_type=Release                           ^
                  -s compiler=msvc                                ^
                  -s compiler.version=14.3                        ^
                  -s compiler.cppstd=23                           ^
                  -c tools.system.package_manager:mode=install    ^
                  -c tools.system.package_manager:sudo=True

            - name: Configure CMake
              shell: bash
              run: cmake -S lib/rtnt -B lib/rtnt/build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake -DRTNT_BUILD_TESTS=ON -DCMAKE_CXX_STANDARD=23

            - name: Build Project
              shell: bash
              run: cmake --build lib/rtnt/build --config Release --parallel

            - name: Run Tests
              working-directory: lib/rtnt/build
              run: ctest --output-on-failure -C Release

            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: rtnt-binaries-${{ matrix.os }}
                  path: |
                      lib/rtnt/build/lib/librtnt.a
                      lib/rtnt/build/tests/rtnt_tests
                      lib/rtnt/build/tests/logs/latest.log
                  retention-days: 5
                  if-no-files-found: warn
